<!DOCTYPE html>
<html>
  <head>
    <title>How to enable high availability</title>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      .collapsible {
	  cursor: pointer;
	  border: none;
	  outline: none;
	  margin: 0;
	  padding:0;
      }

      .content {
	  display: none;
	  overflow: hidden;
      }

      .collapsible:after {
	  content: '\003E'; /* Unicode right-pointing arrow */
	  float: right;
      }
      .collapsible.active:after {
	  content: 'v'; 
      }
    </style>
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      #sidebar ul {margin-left:0;margin-top:0;margin-bottom:0;list-style-type:none;padding-left:20px;}
      #sidebar li {margin: 4px 0;}
      #sidebar details {margin-top:0;margin-bottom:0;}
      #sidebar details > summary {
	  padding: 0px;
	  margin-top: 0px;
	  margin-bottom: 0px;
	  width: 200px;
	  background-color: #ffffff;
	  border: none;
	  cursor: pointer;
    	  list-style-type: "< ";
	  direction: rtl;
      }
      #sidebar details[open] > summary {
	  list-style-type: "v ";
      }

      </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;
      <strong>Offline docs</strong>
      <a href="https://maas.io/docs">(switch to live docs)</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <!-- this is left in just in case we have to update --
	-- older html versions that still use tabs; tbh, we --
	-- should be slowly doing  away with these; other --
	-- changes will be needed, since the older directory --
	-- structures are no longer differentiated, but left --
	-- in place for now so we don't have to dork around --
	-- with the build tools, which expect the subdirs -->
          </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <ul>
	<li>
	  <a href="maas-documentation.html"><b>MAAS Documentation</b></a>
	</li>
        <hr style="margin-top: 15px;">
	<li>
 	  <button class="collapsible" id="m01"><a href="tutorials.html">Tutorials&nbsp;&nbsp;&nbsp;</a></button>
	  <div class="content" id="m02">
	    <ul>
	      <li>
		<a href="tutorial-bootstrapping-maas.html">Bootstrapping MAAS</a>
	      </li>
	      <li>
		<a href="tutorial-try-the-maas-cli.html">Try the MAAS CLI</a>
	      </li>
	      <li>
		<a href="tutorial-creating-custom-images.html">Creating custom images</a>
	      </li>
	      <li>
		<a href="tutorial-get-fancy-cli-output.html">Get fancy CLI output</a>
	      </li>
	    </ul>
	  </div>
	</li>
	<hr style="margin-top: 15px;">
	<li>
	  <button class="collapsible" id="m03"><a href="how-to-guides.html">How-to guides&nbsp;&nbsp;&nbsp;</a></button>
	  <div class="content" id="m04">
	    <ul>
	      <li>
		<button class="collapsible" id="m05"><a href="how-to-set-up-maas.html">Set up MAAS&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m06">
		  <ul>
		    <li>
		      <a href="how-to-install-maas.html">Install MAAS</a>
		    </li>
		    <li>
		      <a href="how-to-upgrade-maas.html">Upgrade MAAS</a>
		    </li>
		    <li>
		      <a href="how-to-back-up-maas.html">Back up MAAS</a>
		    </li>
		  </ul>
		</div>
	      </li>
	      <li>
		<button class="collapsible" id="m07"><a href="how-to-manage-maas-networks.html">Manage MAAS networks&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m08">
		  <ul>
		    <li>
		      <a href="how-to-connect-maas-networks.html">Connect MAAS networks</a>
		    </li>
		    <li>
		      <a href="how-to-enable-dhcp.html">Enable DHCP</a>
		    </li>
		    <li>
		      <a href="how-to-use-availability-zones.html">Use availability zones</a>
		    </li>
		  </ul>
		</div>
	      </li>
	      <li>
		<button class="collapsible" id="m09"><a href="how-to-manage-maas-images.html">Manage MAAS images&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m10">
		  <ul>
		    <li>
		      <a href="how-to-use-standard-images.html">Use standard images</a>
		    </li>
		    <li>
		      <a href="how-to-mirror-maas-images.html">Mirror MAAS images</a>
		    </li>
		    <li>
		      <a href="how-to-deploy-a-real-time-kernel.html">Deploy a real-time kernel</a>
		    </li>
		    <li>
		      <a href="how-to-use-vmware-images.html">Use VMWare images</a>
		    </li>
		    <li>
		      <a href="how-to-deploy-a-fips-compliant-kernel.html">Deploy a FIPS-compliant kernel</a>
		    </li>
		  </ul>
		</div>
	      </li>
	      <li>
		<button class="collapsible" id="m12"><a href="how-to-customise-images.html">Customise images&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m13">
		  <ul>
		    <li>
		      <a href="how-to-build-maas-images.html">Build MAAS images</a>
		    </li>
		    <li>
		      <a href="how-to-build-an-ubuntu-image.html">Build an Ubuntu image</a>
		    </li>
		    <li>
		      <a href="how-to-build-a-rhel-7-image.html">Build a RHEL 7 image</a>
		    </li>
		    <li>
		      <a href="how-to-build-a-rhel-8-image.html">Build a RHEL 8 image</a>
		    </li>
		    <li>
		      <a href="how-to-build-a-centos-7-image.html">Build a CentOS 7 image</a>
		    </li>
		    <li>
		      <a href="how-to-build-an-esxi-image.html">Build an ESXi image</a>
		    </li>
		    <li>
		      <a href="how-to-build-a-windows-image.html">Build a Windows image</a>
		    </li>
		  </ul>
		</div>
	      </li>
	      <li>
		<button class="collapsible" id="m14"><a href="how-to-manage-controllers.html">Manage controllers&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m15">
		  <ul>
		    <li>
		      <a href="how-to-configure-controllers.html">Configure controllers</a>
		    </li>
		    <li>
		      <a href="how-to-enable-high-availability.html">Enable high availability</a>
		    </li>
		  </ul>
		</div>
	      </li>
	      <li>
		<button class="collapsible" id="m16"><a href="how-to-use-machines.html">Use machines&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m17">
		  <ul>
		    <li>
		      <a href="how-to-manage-machines.html">Manage machines</a>
		    </li>
		    <li>
		      <a href="how-to-customise-machines.html">Customise machines</a>
		    </li>
		    <li>
		      <a href="how-to-commission-machines-with-maas.html">Commission machines</a>
		    </li>
		    <li>
		      <a href="how-to-allocate-machines-with-maas.html">Allocate machines</a>
		    </li>
		    <li>
		      <a href="how-to-deploy-machines-with-maas.html">Deploy machines</a>
		    </li>
		    <li>
		      <a href="how-to-use-resource-pools.html">Use resource pools</a>
		    </li>
		    <li>
		      <a href="how-to-set-up-power-drivers.html">Set up power drivers</a>
		    </li>
		  </ul>
		</div>
	      </li>
	      <li>
		<button class="collapsible" id="m18"><a href="how-to-manage-storage.html">Manage storage&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m19">
		  <ul>
		    <li>
		      <a href="how-to-configure-storage-layouts.html">Configure storage layouts</a>
		    </li>
		    <li>
		      <a href="how-to-manage-block-devices.html">Manage block devices</a>
		    </li>
		    <li>
		      <a href="how-to-manage-partitions.html">Manage partitions</a>
		    </li>
		    <li>
		      <a href="how-to-manage-vmfs-datastores.html">Manage VMFS datastores</a>
		    </li>
		    <li>
		      <a href="how-to-create-custom-storage.html">Create custom storage</a>
		    </li>
		  </ul>
		</div>
	      </li>
	      <li>
		<button class="collapsible" id="m20"><a href="how-to-use-virtual-machines.html">Use virtual machines&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m21">
		  <ul>
		    <li>
		      <a href="how-to-set-up-external-lxd.html">Set up external LXD</a>
		    </li>
		    <li>
		      <a href="how-to-use-external-lxd.html">Use external LXD</a>
		    </li>
		    <li>
		      <a href="how-to-use-lxd-projects.html">Use LXD projects</a>
		    </li>
		    <li>
		      <a href="how-to-manage-virtual-machines.html">Manage virtual machines</a>
		    </li>
		    <li>
		      <a href="how-to-deploy-vms-on-ibm-z.html">Deploy VMs on IBM Z</a>
		    </li>
		  </ul>
		</div>
	      </li>
	      <li>
		<button class="collapsible" id="m22"><a href="how-to-label-machines.html">Label machines&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m23">
		  <ul>
		    <li>
		      <a href="how-to-manage-tags.html">Manage
			tags</a>
		    </li>
		    <li>
		      <a href="how-to-annotate-machines.html">Annotate
			machines</a>
		    </li>
		    <li>
		      <a href="how-to-use-machine-tags.html">Use
			machine tags</a>
		    </li>
		    <li>
		      <a href="how-to-use-controller-tags.html">Use
			controller tags</a>
		    </li>
		    <li>
		      <a href="how-to-use-storage-tags.html">Use
			storage tags</a>
		    </li>
		    <li>
		      <a href="how-to-use-network-tags.html">Use
			network tags</a>
		    </li>
		  </ul>
		</div>
	      </li>
	      <li>
		<button class="collapsible" id="m24"><a href="how-to-use-logging.html">Use logging&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m25">
		  <ul>
		    <li>
		      <a href="how-to-read-event-logs.html">Read event logs</a>
		    </li>
		    <li>
		      <a href="how-to-review-audit-logs.html">Review audit logs</a>
		    </li>
		    <li>
		      <a href="how-to-read-commissioning-logs.html">Read commissioning logs</a>
		    </li>
		    <li>
		      <a href="how-to-interpret-testing-logs.html">Interpret testing logs</a>
		    </li>
		    <li>
		      <a href="how-to-use-maas-systemd-logs.html">Use MAAS systemd logs</a>
		    </li>
		  </ul>
		</div>
	      </li>
	      <li>
		<button class="collapsible" id="m26"><a href="how-to-secure-maas.html">Secure MAAS&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m27">
		  <ul>
		    <li>
		      <a href="how-to-enhance-maas-security">Enhance MAAS security</a>
		    </li>
		    <li>
		      <a href="how-to-manage-user-access.html">Manage user access</a>
		    </li>
		    <li>
		      <a href="how-to-implement-tls.html">Implement TLS</a>
		    </li>
		    <li>
		      <a href="how-to-integrate-vault.html">Integrate Vault</a>
		    </li>
		    <li>
		      <a href="how-to-configure-an-air-gapped-maas.html">Configure an air-gapped MAAS</a>
		    </li>
		  </ul>
		</div>
	      </li>
	      <li>
		<button class="collapsible" id="m28"><a href="how-to-change-maas-settings.html">Change MAAS settings&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m29">
		  <ul>
		    <li>
		      <a href="how-to-change-maas-3-4-settings.html">Change MAAS 3.4 settings</a>
		    </li>
		    <li>
		      <a href="how-to-change-maas-3-3-settings.html">Change MAAS 3.3 settings</a>
		    </li>
		    <li>
		      <a href="how-to-change-settings-with-the-cli.html">Change settings with the CLI</a>
		    </li>
		  </ul>
		</div>
	      </li>
	      <li>
		<button class="collapsible" id="m30"><a href="how-to-operate-maas.html">Operate MAAS&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m31">
		  <ul>
		    <li>
		      <a href="how-to-locate-machines.html">Locate machines</a>
		    </li>
		    <li>
		      <a href="how-to-monitor-maas.html">Monitor MAAS</a>
		    </li>
		    <li>
		      <a href="how-to-audit-maas.html">Audit MAAS</a>
		    </li>
		    <li>
		      <a href="how-to-upgrade-postgresql-v12-to-v14.html">Upgrade PostgreSQL v12 to v14</a>
		    </li>
		    <li>
		      <a href="how-to-troubleshoot-common-issues.html">Troubleshoot common issues</a>
		    </li>
		    <li>
		      <a href="how-to-authenticate-to-the-maas-api.html">Authenticate to the MAAS API</a>
		    </li>
		    <li>
		      <a href="how-to-use-the-python-api-client.html">Use the Python API client</a>
		    </li>
		  </ul>
		</div>
	      </li>
	      <li>
		<button class="collapsible" id="m32"><a href="how-to-join-the-community.html">Join the community&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m33">
		  <ul>
		    <li>
		      <a href="how-to-engage-on-the-discourse-forum.html">Engage on the Discourse forum</a>
		    </li>
		    <li>
		      <a href="https://ubuntu.com/pro">How to get support</a>
		    </li>
		    <li>
		      <a href="how-to-request-features.html">Request features</a>
		    </li>
		    <li>
		      <a href="how-to-report-and-review-bugs.html">Report and review bugs</a>
		    </li>
		    <li>
		      <a href="how-to-contribute-to-maas-documentation.html">Contribute to MAAS documentation</a>
		    </li>
		    <li>
		      <a href="how-to-contact-us.html">How to contact us</a>
		    </li>
		  </ul>
		</div>
	      </li>
	    </ul>
	  </div>
	</li>
	<hr style="margin-top: 15px;">
	<li>
	  <button class="collapsible" id="m34"><a href="reference.html">Reference&nbsp;&nbsp;&nbsp;</a></button>
	  <div class="content" id="m35">
	    <ul>
	      <li>
		<button class="collapsible" id="m36"><a href="reference-general-information.html">General information&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m37">
		  <ul>
		    <li>
		      <a href="reference-installation-requirements.html">Installation requirements</a>
		    </li>
		    <li>
		      <a href="https://launchpad.net/maas">MAAS source code</a>
		    </li>
		    <li>
		      <a href="reference-documentation-style-guide.html">Documentation style guide</a>
		    </li>
		    <li>
		      <a href="reference-maas-glossary.html">MAAS glossary</a>
		    </li>
		    <li>
		      <a href="https://ubuntu.com/community/code-of-conduct">MAAS community code of conduct</a>
		    </li>
		    <li>
		      <a href="reference-api-documentation.html">MAAS API reference</a>
		    </li>
		  </ul>
		</div>
	      </li>
	      <li>
		<button class="collapsible" id="m38"><a href="reference-maas-scripts.html">Scripts and automation&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m39">
		  <ul>
		    <li>
		      <a href="reference-commissioning-scripts.html">Commissioning scripts</a>
		    </li>
		    <li>
		      <a href="reference-hardware-test-scripts.html">Hardware test scripts</a>
		    </li>
		    <li>
		      <a href="reference-terraform.html">Terraform IAC</a>
		    </li>
		  </ul>
		</div>
	      </li>
	      <li>
		<a href="reference-device-labels.html">Device labels</a>
	      </li>
	      <li>
		<a href="reference-maas-metrics.html">MAAS metrics</a>
	      </li>
	      <li>
		<a href="reference-power-drivers.html">Power drivers</a>
	      </li>
	      <li>
		<a href="reference-bmc-drivers.html">BMC drivers</a>
	      </li>
	      <li>
		<a href="reference-maas-storage.html">Storage reference</a>
	      </li>
	      <li>
		<button class="collapsible" id="m40"><a href="reference-release-notes.html">Release notes and version details&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m41">
		  <ul>
		    <li>
		      <a href="reference-release-notes-maas-3-4.html">MAAS
			3.4 release notes</a>
		    </li>
		    <li>
		      <a href="reference-release-notes-maas-3-3.html">MAAS
			3.3 release notes</a>
		    </li>
		    <li>
		      <a href="reference-release-notes-maas-3-2.html">MAAS
			3.2 release notes</a>
		    </li>
		    <li>
		      <a href="reference-release-notes-maas-3-1.html">MAAS
			3.1 release notes</a>
		    </li>
		    <li>
		      <a href="reference-release-notes-maas-3-0.html">MAAS
			3.0 release notes</a>
		    </li>
		    <li>
		      <a href="reference-release-notes-maas-2-9.html">MAAS
			2.9 release notes</a>
		    </li>
		    <li>
		      <a href="reference-release-notes-maas-2-8.html">MAAS
			2.8 release notes</a>
		    </li>
		    <li>
		      <a href="reference-release-notes-maas-2-7.html">MAAS
			2.7 release notes</a>
		    </li>
		  </ul>
		</div>
	      </li>
	    </ul>
	  </div>
	</li>
	<hr style="margin-top: 15px;">
	<li>
	  <button class="collapsible" id="m42"><a href="explanation.html">Explanation&nbsp;&nbsp;&nbsp;</a></button>
	  <div class="content" id="m43">
	    <ul>
	      <li>
		<a href="about-maas.html">MAAS</a>
	      </li>
	      <li>
		<button class="collapsible" id="m44"><a href="about-machines.html">Machines&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m45">
		  <ul>
		    <li>
		      <a    href="about-machine-basics.html">Machine
			basics</a>
		    </li>
		    <li>
		      <a href="about-commissioning-machines.html">Commissioning
			machines</a>
		    </li>
		    <li>
		      <a href="about-the-machine-life-cycle.html">The
			machine life-cycle</a>
		    </li>
		    <li>
		      <a href="about-deploying-machines.html">Deploying
			machines</a>
		    </li>
		    <li>
		      <a href="about-machine-customisation.html">Machine
			customisation</a>
		    </li>
		    <li>
		      <a href="about-deploying-running-machines.html">Deploying
			running machines</a>
		    </li>
		  </ul>
		</div>
	      </li>
	      <li>
		<button class="collapsible" id="m46"><a href="about-virtual-machines.html">Virtual machines&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m47">
		  <ul>
		    <li>
		      <a href="about-lxd.html">LXD</a>
		    </li>
		    <li>
		      <a href="about-lxd-projects.html">LXD projects</a>
		    </li>
		  </ul>
		</div>
	      </li>
	      <li>
		<button class="collapsible" id="m48"><a href="about-images.html">Images&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m49">
		  <ul>
		    <li>
		      <a href="about-standard-images.html">Standard images</a>
		    </li>
		    <li>
		      <a href="about-custom-images.html">Custom images</a>
		    </li>
		  </ul>
		</div>
	      <li>
		<a href="about-controllers.html">Controllers</a>
	      </li>
	      <li>
		<a href="about-device-labels.html">Device labels</a>
	      </li>
	      <li>
		<button class="collapsible" id="m50"><a href="about-maas-networks.html">MAAS networks&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m51">
		  <ul>
		    <li>
		      <a href="about-the-osi-model.html">The OSI model</a>
		    </li>
		    <li>
		      <a href="about-tcp-ip.html">TCP/IP</a>
		    </li>
		    <li>
		      <a href="about-dhcp-in-maas.html">DHCP in MAAS</a>
		    </li>
		    <li>
		      <a href="about-cloud-networking.html">Cloud networking</a>
		    </li>
		  </ul>
		</div>
	      </li>
	      <li>
		<button class="collapsible" id="m52"><a href="about-monitoring-and-logging.html">Monitoring and logging&nbsp;&nbsp;&nbsp;</a></button>
		<div class="content" id="m53">
		  <ul>
		    <li>
		      <a href="about-maas-performance.html">MAAS performance</a>
		    </li>
		    <li>
		      <a href="about-maas-events.html">MAAS events</a>
		    </li>
		    <li>
		      <a href="about-audit-events.html">Audit events</a>
		    </li>
		    <li>
		      <a href="about-maas-logging.html">MAAS logging</a>
		    </li>
		  </ul>
		</div>
	      </li>
	      <li>
		<a href="about-maas-security.html">Ensuring security in MAAS</a>
	      </li>
	      <li>
	      </li>
	    </ul>
	  </div>
	</li>
      </ul>
    </div>
    <div class="container" style="float:left; width:60%; margin-left: 40px; margin-top:40px; margin-right:30px">
      
      <h1>How to enable high availability</h1>
      <blockquote>
      <p><em>Errors or typos? Topics missing? Hard to read? <a href="https://docs.google.com/forms/d/e/1FAIpQLScIt3ffetkaKW3gDv6FDk7CfUTNYP_HGmqQotSTtj2htKkVBw/viewform?usp=pp_url&entry.1739714854=https://maas.io/docs/ensuring-high-availability-for-controllers" target = "_blank">Let us know.</a></em></p>
      </blockquote>
      <p>Region and rack controllers balance the load and execute failover, automatically, as part of normal operations. This article will help you understand how to take advantage of these built-in features.</p>
      <h2 id="enter-ha-mode">Enter HA mode</h2>
      <p>To enable high availability, just <a href="how-to-configure-controllers.html">install multiple rack controllers</a>; the rest is automatic. MAAS will immediately begin to load balance:</p>
      <ul>
      <li>racks to regions.</li>
      <li>rack controller connection count.</li>
      <li>region worker processes.</li>
      </ul>
      <p>Every rack-to-region connection initiates a re-balancing loop. Re-balancing is also done at various other opportune times. For example, if a network change happens (like toggling DHCP or changing a VLAN), MAAS will also redistribute load.</p>
      <h2 id="ha-bmc">HA BMC</h2>
      <p>You can also enable HA for BMC control (node power cycling) just by adding a second rack controller. MAAS will automatically identify which rack controller is responsible for a BMC, continuously balancing the connections.</p>
      <h2 id="ha-dhcp">HA DHCP</h2>
      <p>You can enable highly-available DHCP services by using MAAS-managed DHCP, and adding rack controllers. This DHCP HA affects the way MAAS manages nodes, including enlistment, commissioning and deployment. It enables primary and secondary DHCP instances to serve the same VLAN. This VLAN replicates all lease information is between rack controllers, so there’s a bit of performance boost for large networks.</p>
      <p>MAAS DHCP automatically creates failover peers, using mostly standard parameters:</p>
      <pre class="nohighlight"><code>failover peer &quot;failover-partner&quot; {
           primary;
           address dhcp-primary.example.com;
           peer address dhcp-secondary.example.com;
           max-response-delay 60;
           max-unacked-updates 10;
           mclt 3600;
           split 255;
           load balance max seconds 3;
      }
      failover peer &quot;failover-partner&quot; {
           secondary;
           address dhcp-secondary.example.com;
           peer address dhcp-primary.example.com;
           max-response-delay 60;
           max-unacked-updates 10;
           load balance max seconds 3;
      }</code></pre>
      <p>Note that the only difference from a standard 50/50 split (<code>split 128</code>) is that the primary DHCP server answers any requests that it can (<code>split 255</code>), within the maximum response delay of 60 seconds and an unacknowledged update count of 10. In this sense, highly-available MAAS DHCP fails over only when absolutely necessary.</p>
      <p>If you are enabling DHCP for the first time after adding a second rack controller, please read <a href="how-to-enable-dhcp.html">Enabling DHCP</a>. On the other hand, if you have already enabled DHCP on your initial rack controller, you’ll need to reconfigure DHCP to get optimum results.</p>
      <h2 id="update-dhcp-ui">Update DHCP (UI)</h2>
      <p>To reconfigure DHCP after adding a new rack controller, select <em>Subnets</em> &gt; VLAN &gt; <em>Reconfigure DHCP</em>. Confirm that you can see the second rack controller under <em>Secondary controller</em> and select <em>Reconfigure DHCP</em>.</p>
      <h2 id="update-dhcp-cli">Update DHCP (CLI)</h2>
      <p>To reconfigure DHCP after adding a new rack controller, use the following sequence of commands:</p>
      <pre class="nohighlight"><code>vid=$(maas maas subnets read | jq -r &#39;.[] | select(.cidr == &quot;10.0.0.0/24&quot;) | .vlan.vid&#39;)
      fabric_name=$(maas maas subnets read | jq -r &#39;.[] | select(.cidr == &quot;10.0.0.0/24&quot;) | .vlan.fabric&#39;)
      query=&quot;.[] | select(.name == \&quot;$fabric_name\&quot;) | .id&quot;
      fabric_id=$(maas maas fabrics read | jq &quot;$query&quot;)
      maas maas ipranges create type=reserved start_ip=10.0.0.3 end_ip=10.0.0.49
      maas maas ipranges create type=dynamic start_ip=10.0.0.50 end_ip=10.0.0.99
      maas maas vlan update ${fabric_id} ${vid} primary_rack=$(hostname) dhcp_on=true</code></pre>
      <p>Be sure to substitute the sample values for those of your own environment.</p>
      <h2 id="multiple-endpoints">Multiple endpoints</h2>
      <p>MAAS will automatically discover and track all reachable region controllers in a single cluster of rack controllers It will also attempt to automatically connect to them if the one in use becomes inaccessible. Administrators can alternatively specify multiple region-controller endpoints for a single rack controller by adding entries to <code>/var/snap/maas/current/rackd.conf</code> (if using Snaps) or <code>/etc/maas/rackd.conf</code> (if using packages). For example:</p>
      <pre class="nohighlight"><code>    .
          .
          .
          maas_url:
            - http://&lt;ip 1&gt;:&lt;port&gt;/MAAS/
            - http://&lt;ip 2&gt;:&lt;port&gt;/MAAS/
          .
          .
          .</code></pre>
      <p>The setup of highly-available DHCP is now complete. Note that, for HA purposes, DHCP provisioning will take into account multiple DNS services when there is more than one region controller on a single region.</p>
      <h2 id="ha-regions">HA regions</h2>
      <p>Implementing highly-available region control is relatively simple. Load balancing is optional, but is highly recommended.</p>
      <h2 id="ha-postgresql">HA PostgreSQL</h2>
      <p>MAAS stores all state information in the PostgreSQL database. It is therefore recommended to run it in HA mode. Configuring HA for PostgreSQL is external to MAAS. You will, therefore, need to study the <a href="https://www.postgresql.org/docs/9.5/static/high-availability.html">PostgreSQL documentation</a><code>↗</code> and implement the variant of HA that makes you feel most comfortable.</p>
      <p>Each region controller uses up to 40 connections to PostgreSQL in high load situations. Running two region controllers requires no modifications to the <code>max_connections</code> in <code>postgresql.conf</code>. More than two region controllers require that <code>max_connections</code> be adjusted to add 40 more connections per added region controller.</p>
      <h2 id="ha-api-services">HA API services</h2>
      <p>Setting up high-availability using snaps is relatively easy:</p>
      <ol type="1">
      <li>Set up PostgreSQL for high-availability as explained above. PostgreSQL should run outside of the snap.</li>
      <li><a href="how-to-install-maas.html">Install</a> the MAAS snap on each machine you intend to use as a rack or region controller. You’ll need the MAAS shared secret, located here, <code>/var/snap/maas/common/maas/secret</code>, on the first region controller you set up.</li>
      <li><a href="how-to-install-maas.html">Initialise the snap</a> as a <code>rack</code> or <code>region</code> controller.</li>
      </ol>
      <p>Note that if you intend to use a machine as a region controller, you’ll need to tell MAAS how to access your PostgreSQL database host with the following arguments:</p>
      <ul>
      <li><code>--database-host DATABASE_HOST</code></li>
      <li><code>--database-name DATABASE_NAME</code></li>
      <li><code>--database-user DATABASE_USER</code></li>
      <li><code>--database-pass DATABASE_PASS</code></li>
      </ul>
      <p>Please see <a href="how-to-configure-controllers.html">Region controllers</a> for more information about how to install and configure rack controllers for multiple region controllers, when using packages.</p>
      <h2 id="load-balancing-the-api">Load balancing the API</h2>
      <p>You can add load balancing with <a href="http://www.haproxy.org/">HAProxy</a><code>↗</code> load-balancing software to support multiple API servers. In this setup, HAProxy provides access to the MAAS web UI and API.</p>
      <blockquote>
      <p><strong>Pro tip</strong>: If you happen to have Apache running on the same server where you intend to install HAProxy, you will need to stop and disable <code>apache2</code>, because HAProxy binds to port 80.</p>
      </blockquote>
      <h2 id="install-haproxy">Install HAProxy</h2>
      <pre class="nohighlight"><code>sudo apt install haproxy</code></pre>
      <h2 id="set-up-haproxy">Set up HAProxy</h2>
      <p>Configure each API server’s load balancer by copying the following into <code>/etc/haproxy/haproxy.cfg</code> (see the <a href="http://cbonte.github.io/haproxy-dconv/1.6/configuration.html">upstream configuration manual (external link)</a><code>↗</code> as a reference). Replace $PRIMARY_API_SERVER_IP and $SECONDARY_API_SERVER_IP with their respective IP addresses:</p>
      <pre class="nohighlight"><code>frontend maas
          bind    *:80
          retries 3
          option  redispatch
          option  http-server-close
          default_backend maas

      backend maas
          timeout server 90s
          balance source
          hash-type consistent
          server localhost localhost:5240 check
          server maas-api-1 $PRIMARY_API_SERVER_IP:5240 check
          server maas-api-2 $SECONDARY_API_SERVER_IP:5240 check</code></pre>
      <p>where <code>maas-api-1</code> and <code>maas-api-2</code> are arbitrary server labels.</p>
      <p>Now restart the load balancer to have these changes take effect:</p>
      <pre class="nohighlight"><code>sudo systemctl restart haproxy</code></pre>
      <p>The configuration of region controller HA is now complete.</p>
      <p><strong>The API server(s) must be now be referenced (e.g. web UI, MAAS CLI) using port 80 (as opposed to port 5240).</strong></p>
      <h2 id="moving-racks">Moving racks</h2>
      <p>In effect, there is no such action as moving a rack controller, although you can delete a rack controller from one MAAS and reinstantiate the same controller (binary-wise) on another MAAS instance. First, delete the rack controller. In the UI, find <em>Controllers</em>, select the rack controller you with to delete, choose <em>Take action</em> and select <em>Delete</em>. You will be asked to confirm.</p>
      <p>If you’re using the CLI, follow this procedure:</p>
      <pre class="nohighlight"><code>maas $PROFILE rack-controller delete $SYSTEM_ID</code></pre>
      <p>where <code>$PROFILE</code> is your admin profile name, and <code>$SYSTEM_ID</code> can be found by examining the output of the command:</p>
      <pre class="nohighlight"><code>maas $PROFILE rack-controllers read</code></pre>
      <p>There is no confirmation step, so make sure you have the right rack controller before proceeding.</p>
      <p>Next, you must register a new rack controller, which is always done from the command line:</p>
      <pre class="nohighlight"><code>sudo maas-rack register --url $MAAS_URL_OF_NEW_MAAS --secret $SECRET_FOR_NEW_MAAS</code></pre>
      <p>where the secret is found in <code>/var/lib/maas/secret</code> (if using Debian packages) or <code>/var/snap/maas/common/maas/secret</code> (if using Snaps).</p>
      <h2 id="avoiding-move-issues">Avoiding move issues</h2>
      <p>There are dangers associate with moving a rack controller – dangers that may generate errors, get you into a non-working state, or cause you significant data loss. These dangers are precipitated by one caveat and two potential mistakes:</p>
      <ul>
      <li><p><strong>Using the same system as a rack controller and a VM host:</strong> While not forbidden or inherently dangerous, using the same machine as both a rack controller and a VM host may cause resource contention and poor performance. If the resources on the system are not more than adequate to cover both tasks, you may see slowdowns (or even apparent “freeze” events) on the system.</p></li>
      <li><p><strong>Moving a rack controller from one version of MAAS to another:</strong> MAAS rack controller software is an integral part of each version of MAAS. If you delete a rack controller from, say, a 2.6 version of MAAS, and attempt to register that 2.6 version of the rack controller code to, say, a 2.9 version of MAAS, you may experience errors and potential data loss. Using the above example, if you are running both a VM host and a rack controller for MAAS 2.6 on one system, and you suddenly decide to delete that rack controller from 2.6 and attempt to register the same code to a 2.9 MAAS, the VM host may fail or disappear. This will possibly delete all the VMs you have created or connected to that VM host – which may result in data loss. This action is not supported.</p></li>
      <li><p><strong>Connecting one instance of a rack controller to two instances of MAAS, regardless of version:</strong> Trying to connect a single rack controller to two different instances of MAAS can result in all sorts of unpredictable (and potentially catastrophic) behaviour. It is not a supported configuration.</p></li>
      </ul>
      <p>Take these warnings to heart. It may seem like a faster approach to “bridge” your existing rack controllers from one MAAS to another – or from one version of MAAS to another – while they’re running. Ultimately, though, it will probably result in more work than just following the recommended approach.</p>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', (event) => {
	  let coll = document.getElementsByClassName("collapsible");

	  for (let i = 0; i < coll.length; i++) {
	      coll[i].addEventListener("click", function() {
		  toggleCollapsible(this);
	      });
	  }
      });

      function toggleCollapsible(element) {
	  element.classList.toggle("active");
	  let content = element.nextElementSibling;
	  if (content.style.display === "none" || content.style.display === "") {
	      content.style.display = "block";
	  } else {
	      content.style.display = "none";
	  }
      }

      // Assuming you have a way to identify which menu item should be open, e.g., via URL
      function openMenuItemBasedOnPage() {
	  let currentPage = window.location.href; // or however you determine the current page
	  let menuItem;

	  // Logic to determine which menu item corresponds to the current page
	  if (currentPage.includes("page1")) {
	      menuItem = document.getElementById("menu-item-1");
	  } else if (currentPage.includes("page2")) {
	      menuItem = document.getElementById("menu-item-2");
	  }

	  if (menuItem) {
	      toggleCollapsible(menuItem);
	      menuItem.classList.add("active");
	  }
      }

      // Call this function when the page loads
      openMenuItemBasedOnPage();
    </script>
  </body>
</html>
